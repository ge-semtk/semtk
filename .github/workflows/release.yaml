# Run when a release is published.
# Build SemTK with Java and Maven.
# Upload SemTK dist tarball to GitHub release page
# Upload SemTK standalone jar to GitHub release page

name: SemTK Release Workflow
on:
  release:
    types: [ published ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        distribution: [ temurin ]
        java-version: [ 11 ]
        os: [ ubuntu-20.04 ]

    steps:
    - name: Check out SemTK source
      uses: actions/checkout@v3

    - name: Set up Java and Maven
      uses: actions/setup-java@v3
      with:
        cache: maven
        distribution: ${{ matrix.distribution }}
        java-version: ${{ matrix.java-version }}

    - name: Build SemTK source
      # Note the tests currently fail in GitHub Actions
      run: mvn -B package -DskipTests

    - name: Upload SemTK dist tarball
      run: |
        cp distribution/target/semtk-opensource-dist.tar.gz semtk-opensource-${{ github.event.release.tag_name }}-dist.tar.gz
        gh release upload ${{ github.event.release.tag_name }} semtk-opensource-${{ github.event.release.tag_name }}-dist.tar.gz --clobber
      env:
        GITHUB_TOKEN: ${{ github.token }}

    - name: Upload SemTK fat standaloneExecutables jar
      run: |
        cp standaloneExecutables/target/standaloneExecutables-jar-with-dependencies.jar semtk-opensource-${{ github.event.release.tag_name }}-standaloneExecutables.jar
        gh release upload ${{ github.event.release.tag_name }} semtk-opensource-${{ github.event.release.tag_name }}-standaloneExecutables.jar --clobber
      env:
        GITHUB_TOKEN: ${{ github.token }}
